---
title: "Figure-1"
author: "Clarissa F. D. Carneiro and Anja Collazo"
date: "2023-01-30"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(scales)
library(WebPower)
library(tidyverse)
```

This is the code used to create figure 1 of the manuscript "Mapping strategies towards improved external validity in preclinical translational research" by Carneiro et al. (2023)

To select these scenarios to present, we explored multiple options that can be accessed in the GitHub repository. 

## No interactions

Starting with assuming no interactions are present*, we can see how sample size requirements change by increasing the complexity of the factorial design in two ways. 

*This would also be applicable when interactions are present in the form of "attenuated interactions" (where the effect size of both groups are in the same diraction, but just change in magnitude).

### Adding more factors

When adding more factors to a design but keeping the same number of levels, sample size requirement changes are very, very trivial, almost unchanged.

Figure 1A
```{r}
# design with 2-5 factors with two levels
# [2 x 2; 2 x 2 x 2; 2 x 2 x 2 x 2; 2 x 2 x 2 x 2 x 2]

# factors:  number of factors in the factorial design 
# levels:   number of levels per factor (here always = 2)
# f:        effect size f 
# The effect size f is represents the ratio between the average variance of the 
# effect of interest (e.g. main effect of factor 1) and the average variance of 
# all groups. 
# Reference: Zhang, Z., & Yuan, K.-H. (2018). Practical Statistical Power Analysis Using Webpower and R (Eds). Granger, IN: ISDSA Press.

factors <- as.numeric(c(1,2,3,4))     
levels <- as.numeric(c(2))
f <- as.numeric(c(0.35, 0.5, 1.0))

# expand.grid() produces all possible combinations of factors, levels and effect size f. 
report <- expand.grid(factors = factors, levels = levels, f = f)

# We add several other variables: 
# ng:       total number of groups within the experiment given a specific number of factors and levels 
# ndf_main: degrees of freedom, calculated for the main effect according to Zhang et al 2018 
# According to standard practice, the type-I error rate alpha is set to 0.05, 
# power to detect the main effect f set to 80%. 

report<- report %>% 
  mutate (ng = factors * levels, 
          ndf_main = (2-1), 
          power = 0.8, 
          alpha = 0.05, 
          n_total = FALSE, 
          design = rep(c("2", "2 x 2", "2 x 2 x 2", "2 x 2 x 2 x 2"), 3)) 


# The neccessary total number of animals in the experiment is than calculated 
# with the WebPower::wp.kanova()

for (i in 1:nrow(report)) {
  result <-  wp.kanova(
    ndf = report$ndf_main[i], 
    f = report$f[i], 
    ng = report$ng[i], 
    alpha = report$alpha[i], 
    power = report$power[i])
  report$n_total[i] <- result$n

}


report <- report%>% 
  mutate(group_ss = n_total / ng)

```
```{r}
Fig1A<-ggplot(report)+ 
  geom_point(aes(x = design, y = n_total, color = as.factor(f)), 
             size = 4) +
  labs( x = "factorial design",
        y = "total sample size",
        color = "effect size f") +
  scale_colour_viridis_d() + 
  theme_classic() + 
  scale_y_continuous(limits = c(0,70), n.breaks = 7)

Fig1A
```

### Adding more levels to a 3 factor design

Keeping constant the number of factors at 3, but sequentially adding more levels to one of the factors (for example, by increasing the number of doses tested, or breaking continuous variables into more categories), sample size increases.

Figure 1B
```{r}
# design with multiple dosage groups & two additional factors

# Here we redo the analysis with a difference in the number of levels for the 
# first factor. Conceptually, we were thinking about a design, in which the main
# treatment (main effect of interest) is given in different dosages, or where a 
# positive and negative control group were used as comparison groups to the treatment group. 
# factor1:  number of levels in factor1 (e.g. dosage groups)
# factor2:  number of levels in factor2 (e.g. sex: male/female)
# factor3:  number of levels in factor3 (e.g. age: 8 weeks/12 weeks)

factor1 <- as.numeric(c(2,3,4))
factor2 <- as.numeric(2) 
factor3 <- as.numeric(2)
f <- as.numeric(c(0.35, 0.5, 1.0))

report2 <- expand.grid(factor1 = factor1, 
                      factor2 = factor2, 
                      factor3 = factor3, 
                      f = f)

report2<- report2 %>% 
  mutate (ng = factor1 * factor2 * factor3, 
          ndf_main = (factor1-1), 
          ndf_interaction = (factor1-1) * (factor2-1) * (factor3-1), 
          power = 0.8,  
          alpha = 0.05, 
          n_total = FALSE, 
          design = rep(c("2 x 2 x 2", "3 x 2 x 2", "4 x 2 x 2"), 3)) 

for (i in 1:nrow(report2)) {
  result <-  wp.kanova(
    ndf = report2$ndf_main[i], 
    f = report2$f[i], 
    ng = report2$ng[i], 
    alpha = report2$alpha[i], 
    power = report2$power[i])
  report2$n_total[i] <- result$n
}

report2 <- report2%>% 
  mutate(group_ss = n_total / ng)

```
```{r}
Fig1B<-ggplot(report2)+ 
  geom_point(aes(x = design, y = n_total, color = as.factor(f)), 
             size = 4)+
  labs( x = "factorial design",
        y = "total sample size",
        color = "effect size f") +
  scale_colour_viridis_d() + 
  theme_classic() + 
  scale_y_continuous(limits = c(0,100), n.breaks = 10)

Fig1B
```

## With interactions present

When interactions are of interest, the complexity of the design and analysis increases a lot. For simplicity, we explored the impact of interactions only in 2x2 designs.

These interactions can take on 3 formats, depending on the effect on each subgroup: *fully-attenuated* interactions have one group with no treatment effect and one group with an effect in any direction and of any size, *partially attenuated* interactions have both groups with effects in the same direction but of different sizes, and *cross-over* interactions have subgroups with effects in opposite directions.

The first two options have milder impacts on the power for the main effect of interest, but the presence of a cross-over interaction might 'mask' the main effect of the factor of interest and, thus, decrease the power for that comparison.

This relationship was explored through simulations, available only in the supplementary material. 

For the main figure, we focused on the sample size requirements for detecting interaction effects, with two visualization options.

### Sample size requirements by effect size on each subgroup

For this visualization, we present the sample sizes *required to detect an interaction effect with 80% power* for each combination of effect sizes of the main variable of interest (e.g., treatment effect) for each subgroup of the second factor in the design (e.g., sex, age or any systematic heterogenization factor).

Figure 1C
```{r}
# Given is 
# J = {0,1} (e.g. treatment, intervention)
# K = {0,1} (e.g. male, female)
# in a 2 x 2 design 
# The interaction effect J x K 
# expressed the difference between treatment effect within 
# each level K 
# (mean[1,0] - mean[0,0]) - (mean[1,1] - mean[0,1]) / 2 * pooled standard deviation 
# to reduce complexity we assume pooledSD = 1

# function to calculate the interaction effect size 
# ref: Sommet et al. 2022

calculate_es_interaction <- function(d1, d2, power = 0.8, sdpooled = 1, alpha = 0.05) {
  numerator <- (4 * (qnorm(1 - alpha/2)+qnorm(power))^2)
  
  es_interaction <- abs((d1 - d2)/(2*sdpooled))
}

# function to calculate the total sample size to power for the interaction effect size 
# ref: Sommet et al. 2022 

calculate_ntotal <- function(d1, d2, power = 0.8, sdpooled = 1, alpha = 0.05) {
  numerator <- (4 * (qnorm(1 - alpha/2)+qnorm(power))^2)
  
  es_interaction <- abs((d1 - d2)/(2*sdpooled))
  
  ntotal <- numerator/(es_interaction^2)
}

# We set values for Cohen's d of the treatment effect for values of factor K equaling 
# K = 1 (d1) and K = 2 (d2)

d1 <- seq(from = -1, to = 1, by = 0.1)
d2 <- seq(from = -1, to = 1, by = 0.1)


# here we combine different values of treatment effect in K = 1 and K = 2 
report3 <- expand.grid(d1 = d1, d2 = d2)

# We are deleting rows in which the treatment effect of K = 1 equals the treatment effect 
# in K = 2. Under this scenario, no interaction is observable. 
report3 <- report3%>%
        mutate(ntotal = NA)

report3 <- report3%>%dplyr::select(d1, d2, ntotal)


# We are adding the values of the interaction effect size and the total sample size 
# calculated with the functions Â´calculate_es_interactionÂ´ and Â´calculate_es_interactionÂ´
# for now with power = 0.8 . 

for (i in 1:nrow(report3)) {
  report3$ntotal[i]<-calculate_ntotal(d1 = report3$d1[i], report3$d2[i])
  report3$round_ntotal[i]<-ceiling(report3$ntotal[i])
  report3$es_interaction[i] <- calculate_es_interaction(d1 = report3$d1[i], d2 = report3$d2[i])
}


report3$log_ntotal <- log10(report3$ntotal)

report3$round_ntotal[report3$round_ntotal=="Inf"] = NA

```
```{r}
logvalues <- c(1.5, 2, 2.5, 3, 3.5, 4)
trans <- ceiling(10^logvalues)

Fig1C<- ggplot(data = report3) + 
        geom_tile(mapping = aes(x = d1, y = d2, fill = round_ntotal))+
        geom_hline(yintercept = 0, linetype = "dashed") +
        geom_vline(xintercept = 0, linetype = "dashed") +
        scale_fill_gradient(low="#dedede", high="black", name = "Sample size", trans = "log10", na.value = 'white')+
        xlab(expression("Cohen's d "["main"]^"k1")) + 
        ylab(expression("Cohen's d "["main"]^"k2")) +
        theme(axis.line = element_blank(),
              plot.title = element_text(face="bold"),
              plot.subtitle = element_text(face="bold"),
              axis.title = element_text(face = "bold")) + 
  theme_classic()
Fig1C
```

### Sample size requirements by interaction effect size

Next, we show the increases in sample size when powering for the interaction effects considering the relationship between this and the main effect of interest.

Figure 1D
```{r}
# functions to calculate total N with power = 80% and alpha-level = 0.05 for the main effect a (treatment vs. control)

calculate_ntotal_interaction <- function(d_ab, power = 0.8, alpha = 0.05) {
  numerator <- (4 * (qnorm(1 - alpha/2)+qnorm(power))^2)
  ntotal <- numerator/(d_ab^2)
}

calculate_ntotal_main <- function(d_a, power = 0.8, alpha = 0.05) {
  numerator <- (4 * (qnorm(1 - alpha/2)+qnorm(power))^2)
  ntotal <- numerator/(d_a^2)
}

# power curves

d_a <- seq(0.5, 2.0, by = 0.1)

d_ab2 <- d_a/2
d_ab3 <- d_a/3
d_ab4 <- d_a/4


report4 <-  tibble(d_a = d_a, 
       d_ab2 = d_ab2, 
       d_ab3 = d_ab3, 
       d_ab4 = d_ab4) %>%
       gather(key = size_i, 
              value = d_i, 
              d_ab2:d_ab4)

report4$n_main <- vector(length = nrow(report4))
report4$n_i <- vector(length = nrow(report4))

for (i in 1:nrow(report4))  {
  report4$n_main[i] <- calculate_ntotal_interaction(d_ab = report4$d_a[i]) 
  report4$n_i[i] <- calculate_ntotal_interaction(d_ab = report4$d_i[i])
}

report4$ratio_n <- report4$n_i/report4$n_main


report4 <- report4 %>%
        gather(key = effect, value = n, n_main:n_i)


report4$size_i <- factor(report4$size_i, 
                    levels = c("d_ab2", "d_ab3", "d_ab4"),
                    labels = c("1/2", "1/3", "1/4")) 
```
```{r}
Fig1D = ggplot(report4) +
  geom_point(aes(x = d_a, y = n, color = size_i, shape = effect))+ 
  scale_y_continuous(limits = c(1,200))+
  labs(x = expression("Cohen's d "["main"]),
       y = "total sample size") +
  scale_shape_discrete(name = "effect size of interest",
                       labels = c("interaction",
                                  "main effect")) + 
  scale_colour_viridis_d(name = "relative interaction effect size",
                         labels = c("1/2 of the main effect size",
                                    "1/3 of the main effect size",
                                    "1/4 of the main effect size")) + 
  geom_point(aes(x = d_a, y = n, shape = effect), data = report4 %>% filter(effect=="n_main")) + 
  theme_classic()



Fig1D
```

## Final figure

```{r}
cowplot::plot_grid(Fig1A, Fig1B, Fig1C, Fig1D, nrow = 2, labels = LETTERS)
ggsave("Figure-1-manuscript.png", width = 40, height = 20, units = "cm")
```